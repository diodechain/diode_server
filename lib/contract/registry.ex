# Diode Server
# Copyright 2019 IoT Blockchain Technology Corporation LLC (IBTC)
# Licensed under the Diode License, Version 1.0
defmodule Contract.Registry do
  @moduledoc """
    Wrapper for the DiodeRegistry contract functions
    as needed by the inner workings of the chain
  """

  @spec miner_value(0 | 1 | 2 | 3, <<_::160>> | Wallet.t(), any()) :: non_neg_integer
  def miner_value(type, address, blockRef) when type >= 0 and type <= 3 do
    call("MinerValue", ["uint8", "address"], [type, address], blockRef)
    |> :binary.decode_unsigned()
  end

  @spec epoch(any()) :: non_neg_integer
  def epoch(blockRef) do
    call("Epoch", [], [], blockRef)
    |> :binary.decode_unsigned()
  end

  def submit_ticket_taw_tx(ticket) do
    Shell.transaction(Diode.miner(), Diode.registry_address(), "SubmitTicketRaw", ["bytes32[]"], [
      ticket
    ])
  end

  defp call(name, types, values, blockRef) do
    {ret, _gas} = Shell.call(Diode.registry_address(), name, types, values, blockRef: blockRef)
    ret
  end

  # This is the code for the test/dev variant of the registry contract
  def test_code() do
    "0x6080604052600436106100e25763ffffffff60e060020a6000350416630a938dff81146100e75780630ac168a1146101205780631b3b98c8146101375780631dd44706146101a15780634fb3ccc5146101b6578063534a2422146101e75780636f9874a4146101fb5780637fca4a29146102105780638d23fc61146102315780638da5cb5b1461025257806399ab110d14610267578063acc77cba14610287578063b0128d921461029b578063be3bb93c146102b3578063c487e3f7146102da578063c4a9e116146102e2578063c76a1173146102f7578063cb106cf81461031b575b600080fd5b3480156100f357600080fd5b5061010e60ff60043516600160a060020a0360243516610330565b60408051918252519081900360200190f35b34801561012c57600080fd5b5061013561059d565b005b34801561014357600080fd5b50604080516060818101909252610135916004803592600160a060020a0360243581169360443590911692606435926084359260a4359236929091610124919060c49060039083908390808284375093965061078995505050505050565b3480156101ad57600080fd5b506101356109f9565b3480156101c257600080fd5b506101cb610bea565b60408051600160a060020a039092168252519081900360200190f35b610135600160a060020a0360043516610bf9565b34801561020757600080fd5b5061010e610d09565b34801561021c57600080fd5b50610135600160a060020a0360043516610d22565b34801561023d57600080fd5b506101cb600160a060020a0360043516610fa3565b34801561025e57600080fd5b506101cb610fbe565b34801561027357600080fd5b506101356004803560248101910135610fcd565b610135600160a060020a0360043516611155565b3480156102a757600080fd5b506101356004356112a7565b3480156102bf57600080fd5b5061010e60ff60043516600160a060020a036024351661139e565b6101356113b1565b3480156102ee57600080fd5b5061010e6113bd565b34801561030357600080fd5b50610135600160a060020a03600435166024356113c3565b34801561032757600080fd5b5061010e6114d4565b600060ff831615156103bb57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114da565b9050610597565b8260ff166001141561043f57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114e9565b8260ff16600214156104c357600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114f8565b8260ff166003141561054757600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b490611507565b6040805160e560020a62461bcd02815260206004820152601260248201527f556e68616e646c656420617267756d656e740000000000000000000000000000604482015290519081900360640190fd5b92915050565b60008080803341148015906105b157504115155b80156105c85750600154600160a060020a03163314155b15610643576040805160e560020a62461bcd02815260206004820152603060248201527f4f6e6c7920746865206d696e6572206f662074686520626c6f636b2063616e2060448201527f63616c6c2074686973206d6574686f6400000000000000000000000000000000606482015290519081900360840190fd5b61064b610d09565b6007541461065b5761065b611516565b61067e41610679670de0b6b3a764000061271063ffffffff61179a16565b6117d3565b600093505b60085484101561077757600880548590811061069b57fe5b6000918252602080832090910154600160a060020a031680835260099091526040909120549093506106d59061271063ffffffff61189a16565b91506106e26000846118bd565b905066038d7ea4c680008110156106fd575066038d7ea4c680005b80821115610709578091505b60008211156107535761071c8383611ad1565b6040518290600160a060020a038516907fc083a1647e3ee591bf42b82564ffb4d16fdbb26068f0080da911c8d8300fd84a90600090a35b600160a060020a038316600090815260096020526040812055600190930192610683565b6107836008600061268e565b50505050565b60606000884381106107e5576040805160e560020a62461bcd02815260206004820152601760248201527f5469636b65742066726f6d20746865206675747572653f000000000000000000604482015290519081900360640190fd5b868617151561083e576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c6964207469636b65742076616c7565000000000000000000000000604482015290519081900360640190fd5b60408051600680825260e08201909252906020820160c080388339019050509250894083600081518110151561087057fe5b602090810290910101528251600160a060020a038a16908490600190811061089457fe5b602090810290910101528251600160a060020a03891690849060029081106108b857fe5b6020908102909101015282518790849060039081106108d357fe5b6020908102909101015282518690849060049081106108ee57fe5b60209081029091010152825185908490600590811061090957fe5b60209081029091010152600161091e84611ba6565b60408087015187516020808a0151845160008082528184018088529790975260ff9094168486015260608401929092526080830191909152915160a080830194601f198301938390039091019190865af1158015610980573d6000803e3d6000fd5b5050506020604051035191506109968983611d04565b6109a38989848a8a611df0565b81600160a060020a031688600160a060020a03168a600160a060020a03167fc21a4132cfb2e72d1dd6f45bcb2dabb1722a19b036c895975db93175b1c5c06f60405160405180910390a450505050505050505050565b336000818152600560208181526040808420815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601529482015492850192909252918101929092529190610a6a90611507565b905060008111610ac4576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610b30908263ffffffff61201316565b600160a060020a0384166000818152600560208181526040808420865180518255808401516001830155820151600282015595820151805160038801559182015160048701559081015194909101939093559151909183156108fc02918491818181858888f19350505050158015610bac573d6000803e3d6000fd5b506040518190600160a060020a038516906000907f7f22ec7a37a3fa31352373081b22bb38e1e0abd2a05b181ee7138a360edd3e1a908290a4505050565b600154600160a060020a031681565b6000610c04826120a0565b600160a060020a038116600090815260066020908152604091829020825160a081018452815481850190815260018301546060808401919091526002840154608084015290825284519081018552600383015481526004830154818501526005909201549382019390935290820152909150610c86903463ffffffff6122ae16565b600160a060020a038216600081815260066020908152604080832085518051825580840151600180840191909155908301516002830155958301518051600383015592830151600482015591810151600590920191909155513493917fd859864511fd3f512da77fc95a8c013b3a0e49bdface8f574b2df8527cecea7191a45050565b6000610d1c43600463ffffffff61189a16565b90505b90565b600080600080610d31856120a0565b935083600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b158015610d7157600080fd5b505af1158015610d85573d6000803e3d6000fd5b505050506040513d6020811015610d9b57600080fd5b5051600160a060020a038516600090815260066020908152604091829020825160a08101845281548185019081526001830154606080840191909152600284015460808401529082528451908101855260038301548152600483015481850152600583015494810194909452918201929092529194509250610e1c90611507565b905060008111610e76576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610ee2908263ffffffff61201316565b600160a060020a038086166000908152600660209081526040808320855180518255808401516001830155820151600282015594820151805160038701559182015160048601559081015160059094019390935591519085169183156108fc02918491818181858888f19350505050158015610f62573d6000803e3d6000fd5b506040518190600160a060020a038616906001907f7f22ec7a37a3fa31352373081b22bb38e1e0abd2a05b181ee7138a360edd3e1a90600090a45050505050565b600460205260009081526040902054600160a060020a031681565b600054600160a060020a031681565b6000610fd76126af565b821580610fe657506009830615155b1561103b576040805160e560020a62461bcd02815260206004820152601560248201527f496e76616c6964207469636b6574206c656e6774680000000000000000000000604482015290519081900360640190fd5b600091505b828210156107835760408051606081019091528085856006860181811061106357fe5b602090810292909201358352500185856007860181811061108057fe5b602090810292909201358352500185856008860181811061109d57fe5b602002919091013590915250905061114a8484848181106110ba57fe5b602002919091013590506110e68686600187018181106110d657fe5b9050602002013560001916610d1f565b6110f88787600288018181106110d657fe5b87876003880181811061110757fe5b6020029190910135905088886004890181811061112057fe5b60200291909101359050898960058a0181811061113957fe5b905060200201356000191687610789565b600982019150611040565b600154600090600160a060020a0316331461116f57600080fd5b600160a060020a038281166000908152600460205260409020541615611205576040805160e560020a62461bcd02815260206004820152602560248201527f44656c656761746520616c726561647920686173206120666c65657420636f6e60448201527f7472616374000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60015430908390600160a060020a031661121d6126ce565b600160a060020a03938416815291831660208301529091166040808301919091525190819003606001906000f08015801561125c573d6000803e3d6000fd5b50600160a060020a038381166000908152600460205260409020805473ffffffffffffffffffffffffffffffffffffffff191691831691909117905590506112a381610bf9565b5050565b33600081815260056020818152604092839020835160a0810185528154818601908152600183015460608084019190915260028401546080840152908252855190810186526003830154815260048301548185015291909301549381019390935281019190915261131e908363ffffffff6122d116565b600160a060020a03821660008181526005602081815260408084208651805182558084015160018301558201516002820155958201518051600388015591820151600487015590810151949091019390935591518492907f81149c79fef0028ec92e02ee17f72b9bba024dce75220cba8d62f7bbcd0922b6908290a45050565b60006113aa83836118bd565b9392505050565b6113bb333461238c565b565b60025481565b60006113ce836120a0565b600160a060020a038116600090815260066020908152604091829020825160a081018452815481850190815260018301546060808401919091526002840154608084015290825284519081018552600383015481526004830154818501526005909201549382019390935290820152909150611450908363ffffffff6122d116565b600160a060020a038216600081815260066020908152604080832085518051825580840151600180840191909155908301516002830155958301518051600383015592830151600482015591810151600590920191909155518593917f81149c79fef0028ec92e02ee17f72b9bba024dce75220cba8d62f7bbcd0922b691a4505050565b60035481565b6000610597826000015161248c565b600061059782600001516124a3565b600061059782602001516124a3565b6000610597826020015161248c565b6000808080808080808080805b600a5489101561177657600a80548a90811061153b57fe5b600091825260209091200154600160a060020a0316975061155b886124b7565b965061156e87606463ffffffff61189a16565b600160a060020a0389166000908152600b602052604090206001810154919b5096506115b7906115a69061040063ffffffff61179a16565b60028801549063ffffffff61253116565b9450600093505b600386015484101561172d57600386018054859081106115da57fe5b6000918252602080832090910154600160a060020a03168083526004890190915260409091206001810154919c509350611631906116209061040063ffffffff61179a16565b60028501549063ffffffff61253116565b9150611665856116598c61164d8661271063ffffffff61179a16565b9063ffffffff61179a16565b9063ffffffff61189a16565b91506116718b836117d3565b5060005b60038301548110156116e257826004016000846003018381548110151561169857fe5b6000918252602080832090910154600160a060020a031683528201929092526040018120805460ff1916815560018181018390556002820183905560039091019190915501611675565b600160a060020a038b1660009081526004870160205260408120805460ff19168155600181018290556002810182905590611720600383018261268e565b50506001909301926115be565b600160a060020a0388166000908152600b60205260408120805460ff19168155600181018290556002810182905590611769600383018261268e565b5050600190980197611523565b611782600a600061268e565b61178a610d09565b6007555050505050505050505050565b6000808315156117ad57600091506117cc565b508282028284828115156117bd57fe5b04146117c857600080fd5b8091505b5092915050565b60008111156112a357600160a060020a038216600090815260096020526040902054151561185457600880546001810182556000919091527ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee301805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0384161790555b600160a060020a03821660009081526009602052604090205461187d908263ffffffff61253116565b600160a060020a0383166000908152600960205260409020555050565b6000808083116118a957600080fd5b82848115156118b457fe5b04949350505050565b600060ff8316151561194257600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114da565b8260ff16600114156119c757600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114e9565b8260ff1660021415611a4c57600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114f8565b8260ff166003141561054757600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b490611507565b600160a060020a038216600090815260056020818152604092839020835160a08101855281548186019081526001830154606080840191909152600284015460808401529082528551908101865260038301548152600483015481850152919093015493810193909352810191909152611b51908263ffffffff61254316565b600160a060020a03909216600090815260056020818152604092839020855180518255808301516001830155840151600282015594810151805160038701559081015160048601559091015192019190915550565b600080606060008085519350836020026040519080825280601f01601f191660200182016040528015611be3578160200160208202803883390190505b509250600091505b83821015611c9e575060005b6020811015611c93578582815181101515611c0e57fe5b9060200190602002015181602081101515611c2557fe5b1a7f01000000000000000000000000000000000000000000000000000000000000000283828460200201815181101515611c5b57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600101611bf7565b600190910190611beb565b826040518082805190602001908083835b60208310611cce5780518252601f199092019160209182019101611caf565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091209998505050505050505050565b604080517fd90bd651000000000000000000000000000000000000000000000000000000008152600160a060020a0383811660048301529151849283169163d90bd6519160248083019260209291908290030181600087803b158015611d6957600080fd5b505af1158015611d7d573d6000803e3d6000fd5b505050506040513d6020811015611d9357600080fd5b50511515611deb576040805160e560020a62461bcd02815260206004820152601360248201527f556e726567697374657265642064657669636500000000000000000000000000604482015290519081900360640190fd5b505050565b600160a060020a0385166000908152600b60205260408120805490919081908190819060ff161515611e7f578454600160ff1990911681178655600a805491820181556000527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a801805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038c161790555b600160a060020a03891660009081526004860160205260409020805490945060ff161515611ef1578354600160ff1990911681178555600386018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038b161790555b600160a060020a03881660009081526004850160205260409020805490935060ff161515611f63578254600160ff1990911681178455600385018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038a161790555b8260020154871115611fb5576002830180549088905560018501549088039250611f93908363ffffffff61253116565b600180860191909155850154611faf908363ffffffff61253116565b60018601555b8260030154861115612007575060038201805490869055600284015490860390611fe5908263ffffffff61253116565b600280860191909155850154612001908263ffffffff61253116565b60028601555b50505050505050505050565b61201b6126de565b81612029846020015161248c565b101561207f576040805160e560020a62461bcd02815260206004820152601660248201527f496e737566666963656e742066726565207374616b6500000000000000000000604482015290519081900360640190fd5b6020830151612094908363ffffffff61256e16565b60208401525090919050565b600160a060020a0380821660009081526004602052604081205490911681811561215157600154600160a060020a0316331461214c576040805160e560020a62461bcd02815260206004820152602660248201527f4f6e6c79207468652063726f6e206163636f756e74616e742063616e2063616c60448201527f6c20746869730000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b6117cc565b61216384600160a060020a03166125f3565b15156121b9576040805160e560020a62461bcd02815260206004820152601e60248201527f496e76616c696420666c65657420636f6e747261637420616464726573730000604482015290519081900360640190fd5b83915081600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b1580156121fa57600080fd5b505af115801561220e573d6000803e3d6000fd5b505050506040513d602081101561222457600080fd5b50519050600160a060020a03811633146117cc576040805160e560020a62461bcd02815260206004820152602560248201527f4f6e6c792074686520666c656574206163636f756e74616e742063616e20646f60448201527f2074686973000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b6122b66126de565b82516122c8908363ffffffff6125fb16565b83525090919050565b6122d96126de565b816122e7846000015161248c565b1015612363576040805160e560020a62461bcd02815260206004820152602160248201527f43616e277420756e7374616b65206d6f7265207468616e206973207374616b6560448201527f6400000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b8251612375908363ffffffff61256e16565b83526020830151612094908363ffffffff6125fb16565b600160a060020a038216600090815260056020818152604092839020835160a0810185528154818601908152600183015460608084019190915260028401546080840152908252855190810186526003830154815260048301548185015291909301549381019390935281019190915261240c908263ffffffff6122ae16565b600160a060020a03831660008181526005602081815260408084208651805182558084015160018301558201516002820155958201518051600388015591820151600487015590810151949091019390935591518392907fd859864511fd3f512da77fc95a8c013b3a0e49bdface8f574b2df8527cecea71908290a45050565b60006124998260006125fb565b6040015192915050565b60006124b08260006125fb565b5192915050565b600160a060020a0381166000908152600660209081526040808320815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601526005909201549282019290925291810191909152610597906114da565b6000828201838110156117c857600080fd5b61254b6126de565b825160400151612561908363ffffffff61253116565b8351604001525090919050565b612576612704565b6125818360006125fb565b9050818160400151101515156125e1576040805160e560020a62461bcd02815260206004820152601b60248201527f496e737566666963656e742066756e647320746f206465647563740000000000604482015290519081900360640190fd5b60408101805192909203909152919050565b6000903b1190565b612603612704565b61260c8361267f565b15156126485760408051606081018252838152436020820152845185830151919283019161263f9163ffffffff61253116565b90529050610597565b604080516060810190915283518190612667908563ffffffff61253116565b81524360208201526040858101519101529050610597565b60200151600343919091031090565b50805460008255906000526020600020908101906126ac9190612726565b50565b6060604051908101604052806003906020820280388339509192915050565b6040516102d38061274583390190565b60c0604051908101604052806126f2612704565b81526020016126ff612704565b905290565b6060604051908101604052806000815260200160008152602001600081525090565b610d1f91905b80821115612740576000815560010161272c565b50905600608060405234801561001057600080fd5b506040516060806102d383398101604090815281516020830151919092015160018054600160a060020a03938416600160a060020a03199182161790915560008054948416948216949094179093556002805492909116919092161790556102568061007d6000396000f3006080604052600436106100775763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633c5f7d46811461007c5780634ef1aee4146100a45780634fb3ccc5146100df578063504f04b714610110578063570ca7351461013c578063d90bd65114610151575b600080fd5b34801561008857600080fd5b506100a2600160a060020a03600435166024351515610172565b005b3480156100b057600080fd5b506100cb600160a060020a036004358116906024351661019d565b604080519115158252519081900360200190f35b3480156100eb57600080fd5b506100f46101bd565b60408051600160a060020a039092168252519081900360200190f35b34801561011c57600080fd5b506100a2600160a060020a036004358116906024351660443515156101cc565b34801561014857600080fd5b506100f4610206565b34801561015d57600080fd5b506100cb600160a060020a0360043516610215565b600160a060020a03919091166000908152600660205260409020805460ff1916911515919091179055565b600760209081526000928352604080842090915290825290205460ff1681565b600254600160a060020a031681565b600160a060020a03928316600090815260076020908152604080832094909516825292909252919020805460ff1916911515919091179055565b600154600160a060020a031681565b60066020526000908152604090205460ff16815600a165627a7a723058208df217001cef7e510f8f0352585a03e46b30eba1feaeaf76becbe261832a627f0029a165627a7a72305820d7b0ff8681e08e5a4b813695bb692b508d21fefea8f19882f44c16292aee50290029"
    |> Base16.decode()
  end
end
