defmodule Chain.GenesisFactory do
  alias Chain.Account, as: Account

  @spec testnet() :: Chain.Block.t()
  def testnet() do
    genesis(genesis_accounts(), genesis_transactions(genesis_miner()), genesis_miner())
  end

  def testnet_parent() do
    genesis_parent(genesis_state(genesis_accounts()), genesis_miner())
  end

  defp addr_balance(addr, balance) do
    {Wallet.from_address(addr), %Account{balance: balance}}
  end

  defp addr_account(addr, account) do
    {Wallet.from_address(addr), account}
  end

  @spec genesis_accounts() :: [{Wallet.t(), Account.t()}]
  def genesis_accounts() do
    accountant = 0x96CDE043E986040CB13FFAFD80EB8CEAC196FB84

    std = [
      # The Accountant
      addr_balance(accountant, ether(1000)),
      # The Faucet
      addr_balance(0xBADA81FAE68925FEC725790C34B68B5FACA90D45, ether(1000)),
      # Reserved A-D
      addr_balance(0x34E3961098DE3348B465CC82791BD0F7EBCE3ECD, ether(1000)),
      addr_balance(0xC0C416B326133D74335E6828D558EFE315BD597E, ether(1000)),
      addr_balance(0x58CC80F5526594F07F33FD4BE4AEF153BAB602B2, ether(1000)),
      addr_balance(0x45AA0730CF4216F7195FC1F5903A171A1FAA5209, ether(1000)),

      # The Registry with the accountant placed
      addr_account(
        Diode.registry_address(),
        %Account{
          balance: ether(100_000_000),
          code: Base16.decode(registryContract())
        }
        |> Account.storage_set_value(1, accountant)
      ),

      # The Fleet with the operator and accountant placed
      addr_account(
        Diode.fleet_address(),
        %Account{
          balance: 0,
          code: Base16.decode(fleet_contract())
        }
        |> Account.storage_set_value(0, Diode.registry_address() |> :binary.decode_unsigned())
        |> Account.storage_set_value(2, accountant)
      )
    ]

    if Diode.dev_mode?() do
      std ++
        Enum.map(Diode.wallets(), fn wallet ->
          {wallet, %Account{balance: ether(1000)}}
        end)
    else
      std
    end
  end

  def genesis_miner() do
    Wallet.from_privkey(
      <<149, 210, 74, 221, 235, 25, 240, 87, 85, 95, 119, 147, 106, 182, 149, 28, 112, 227, 22,
        173, 235, 134, 113, 172, 125, 222, 191, 154, 120, 128, 129, 203>>
    )
  end

  @spec genesis_transactions(Wallet.t()) :: [Chain.Transaction.t(), ...]
  def genesis_transactions(miner) do
    # Call "blockReward()":
    priv = miner |> Wallet.privkey!()

    tx =
      %Chain.Transaction{
        nonce: 0,
        gas_price: 0,
        gas_limit: 1_000_000_000,
        to: Diode.registry_address(),
        data: ABI.encode_spec("blockReward")
      }
      |> Chain.Transaction.sign(priv)

    [tx]
  end

  @spec genesis_parent(Chain.State.t(), Wallet.t()) :: Chain.Block.t()
  def genesis_parent(state, miner) do
    %Chain.Block{
      header: %Chain.Header{
        block_hash: nil,
        state_hash: Chain.State.hash(state),
        miner_pubkey: Wallet.pubkey!(miner)
      }
    }
  end

  def genesis_state(accounts) do
    Enum.reduce(accounts, Chain.State.new(), fn {wallet, user_account}, state ->
      Chain.State.set_account(state, Wallet.address!(wallet), user_account)
    end)
  end

  @spec genesis(any(), [Chain.Transaction.t()], Wallet.t()) :: Chain.Block.t()
  def genesis(accounts, transactions, miner) do
    state = genesis_state(accounts)
    Chain.state_store(state)

    parent = genesis_parent(state, miner)
    block = Chain.Block.create(parent, transactions, miner, 1_555_510_594)
    header = Chain.Block.header(block)

    header =
      %{header | miner_signature: <<0::520>>}
      |> Chain.Header.update_hash()

    %{block | header: header}
  end

  defp ether(x) do
    Shell.ether(x)
  end

  defp registryContract() do
    if Diode.dev_mode?() do
      test_registry_contract()
    else
      prodRegistryContract()
    end
  end

  defp test_registry_contract() do
    "0x6080604052600436106100e25763ffffffff60e060020a6000350416630a938dff81146100e75780630ac168a1146101205780631b3b98c8146101375780631dd44706146101a15780634fb3ccc5146101b6578063534a2422146101e75780636f9874a4146101fb5780637fca4a29146102105780638d23fc61146102315780638da5cb5b1461025257806399ab110d14610267578063acc77cba14610287578063b0128d921461029b578063be3bb93c146102b3578063c487e3f7146102da578063c4a9e116146102e2578063c76a1173146102f7578063cb106cf81461031b575b600080fd5b3480156100f357600080fd5b5061010e60ff60043516600160a060020a0360243516610330565b60408051918252519081900360200190f35b34801561012c57600080fd5b5061013561059d565b005b34801561014357600080fd5b50604080516060818101909252610135916004803592600160a060020a0360243581169360443590911692606435926084359260a4359236929091610124919060c49060039083908390808284375093965061077095505050505050565b3480156101ad57600080fd5b506101356109e0565b3480156101c257600080fd5b506101cb610b93565b60408051600160a060020a039092168252519081900360200190f35b610135600160a060020a0360043516610ba2565b34801561020757600080fd5b5061010e610c82565b34801561021c57600080fd5b50610135600160a060020a0360043516610c9b565b34801561023d57600080fd5b506101cb600160a060020a0360043516610ee3565b34801561025e57600080fd5b506101cb610efe565b34801561027357600080fd5b506101356004803560248101910135610f0d565b610135600160a060020a0360043516611095565b3480156102a757600080fd5b506101356004356111e7565b3480156102bf57600080fd5b5061010e60ff60043516600160a060020a03602435166112b0565b6101356112c3565b3480156102ee57600080fd5b5061010e6112cf565b34801561030357600080fd5b50610135600160a060020a03600435166024356112d5565b34801561032757600080fd5b5061010e6113b6565b600060ff831615156103bb57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906113bc565b9050610597565b8260ff166001141561043f57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906113cb565b8260ff16600214156104c357600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906113da565b8260ff166003141561054757600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906113e9565b6040805160e560020a62461bcd02815260206004820152601260248201527f556e68616e646c656420617267756d656e740000000000000000000000000000604482015290519081900360640190fd5b92915050565b60008080803341148015906105b157504115155b80156105c85750600154600160a060020a03163314155b15610643576040805160e560020a62461bcd02815260206004820152603060248201527f4f6e6c7920746865206d696e6572206f662074686520626c6f636b2063616e2060448201527f63616c6c2074686973206d6574686f6400000000000000000000000000000000606482015290519081900360840190fd5b61064b610c82565b6007541461065b5761065b6113f8565b61067e41610679670de0b6b3a764000061271063ffffffff61167c16565b6116b5565b600093505b60085484101561075e57600880548590811061069b57fe5b6000918252602080832090910154600160a060020a031680835260099091526040909120549093506106d59061271063ffffffff61177c16565b91506106e260008461179f565b9050808211156106f0578091505b600082111561073a5761070383836119b3565b6040518290600160a060020a038516907fc083a1647e3ee591bf42b82564ffb4d16fdbb26068f0080da911c8d8300fd84a90600090a35b600160a060020a038316600090815260096020526040812055600190930192610683565b61076a600860006124f0565b50505050565b60606000884381106107cc576040805160e560020a62461bcd02815260206004820152601760248201527f5469636b65742066726f6d20746865206675747572653f000000000000000000604482015290519081900360640190fd5b8686171515610825576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c6964207469636b65742076616c7565000000000000000000000000604482015290519081900360640190fd5b60408051600680825260e08201909252906020820160c080388339019050509250894083600081518110151561085757fe5b602090810290910101528251600160a060020a038a16908490600190811061087b57fe5b602090810290910101528251600160a060020a038916908490600290811061089f57fe5b6020908102909101015282518790849060039081106108ba57fe5b6020908102909101015282518690849060049081106108d557fe5b6020908102909101015282518590849060059081106108f057fe5b60209081029091010152600161090584611a88565b60408087015187516020808a0151845160008082528184018088529790975260ff9094168486015260608401929092526080830191909152915160a080830194601f198301938390039091019190865af1158015610967573d6000803e3d6000fd5b50505060206040510351915061097d8983611be6565b61098a8989848a8a611cd2565b81600160a060020a031688600160a060020a03168a600160a060020a03167fc21a4132cfb2e72d1dd6f45bcb2dabb1722a19b036c895975db93175b1c5c06f60405160405180910390a450505050505050505050565b336000818152600560208181526040808420815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601529482015492850192909252918101929092529190610a51906113e9565b905060008111610aab576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610b17908263ffffffff611ef516565b600160a060020a0384166000818152600560208181526040808420865180518255808401516001830155820151600282015595820151805160038801559182015160048701559081015194909101939093559151909183156108fc02918491818181858888f1935050505015801561076a573d6000803e3d6000fd5b600154600160a060020a031681565b6000610bad82611f82565b600160a060020a038116600090815260066020908152604091829020825160a081018452815481850190815260018301546060808401919091526002840154608084015290825284519081018552600383015481526004830154818501526005909201549382019390935290820152909150610c2f903463ffffffff61219016565b600160a060020a0390911660009081526006602090815260409182902083518051825580830151600183015583015160028201559281015180516003850155908101516004840155015160059091015550565b6000610c9543600463ffffffff61177c16565b90505b90565b600080600080610caa85611f82565b935083600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b158015610cea57600080fd5b505af1158015610cfe573d6000803e3d6000fd5b505050506040513d6020811015610d1457600080fd5b5051600160a060020a038516600090815260066020908152604091829020825160a08101845281548185019081526001830154606080840191909152600284015460808401529082528451908101855260038301548152600483015481850152600583015494810194909452918201929092529194509250610d95906113e9565b905060008111610def576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610e5b908263ffffffff611ef516565b600160a060020a038086166000908152600660209081526040808320855180518255808401516001830155820151600282015594820151805160038701559182015160048601559081015160059094019390935591519085169183156108fc02918491818181858888f19350505050158015610edb573d6000803e3d6000fd5b505050505050565b600460205260009081526040902054600160a060020a031681565b600054600160a060020a031681565b6000610f17612511565b821580610f2657506009830615155b15610f7b576040805160e560020a62461bcd02815260206004820152601560248201527f496e76616c6964207469636b6574206c656e6774680000000000000000000000604482015290519081900360640190fd5b600091505b8282101561076a57604080516060810190915280858560068601818110610fa357fe5b6020908102929092013583525001858560078601818110610fc057fe5b6020908102929092013583525001858560088601818110610fdd57fe5b602002919091013590915250905061108a848484818110610ffa57fe5b6020029190910135905061102686866001870181811061101657fe5b9050602002013560001916610c98565b61103887876002880181811061101657fe5b87876003880181811061104757fe5b6020029190910135905088886004890181811061106057fe5b60200291909101359050898960058a0181811061107957fe5b905060200201356000191687610770565b600982019150610f80565b600154600090600160a060020a031633146110af57600080fd5b600160a060020a038281166000908152600460205260409020541615611145576040805160e560020a62461bcd02815260206004820152602560248201527f44656c656761746520616c726561647920686173206120666c65657420636f6e60448201527f7472616374000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60015430908390600160a060020a031661115d612530565b600160a060020a03938416815291831660208301529091166040808301919091525190819003606001906000f08015801561119c573d6000803e3d6000fd5b50600160a060020a038381166000908152600460205260409020805473ffffffffffffffffffffffffffffffffffffffff191691831691909117905590506111e381610ba2565b5050565b33600081815260056020818152604092839020835160a0810185528154818601908152600183015460608084019190915260028401546080840152908252855190810186526003830154815260048301548185015291909301549381019390935281019190915261125e908363ffffffff6121b316565b600160a060020a03909116600090815260056020818152604092839020845180518255808301516001830155840151600282015593810151805160038601559081015160048501559091015191015550565b60006112bc838361179f565b9392505050565b6112cd333461226e565b565b60025481565b60006112e083611f82565b600160a060020a038116600090815260066020908152604091829020825160a081018452815481850190815260018301546060808401919091526002840154608084015290825284519081018552600383015481526004830154818501526005909201549382019390935290820152909150611362908363ffffffff6121b316565b600160a060020a039091166000908152600660209081526040918290208351805182558083015160018301558301516002820155928101518051600385015590810151600484015501516005909101555050565b60035481565b600061059782600001516122ee565b60006105978260000151612305565b60006105978260200151612305565b600061059782602001516122ee565b6000808080808080808080805b600a5489101561165857600a80548a90811061141d57fe5b600091825260209091200154600160a060020a0316975061143d88612319565b965061145087606463ffffffff61177c16565b600160a060020a0389166000908152600b602052604090206001810154919b509650611499906114889061040063ffffffff61167c16565b60028801549063ffffffff61239316565b9450600093505b600386015484101561160f57600386018054859081106114bc57fe5b6000918252602080832090910154600160a060020a03168083526004890190915260409091206001810154919c509350611513906115029061040063ffffffff61167c16565b60028501549063ffffffff61239316565b91506115478561153b8c61152f8661271063ffffffff61167c16565b9063ffffffff61167c16565b9063ffffffff61177c16565b91506115538b836116b5565b5060005b60038301548110156115c457826004016000846003018381548110151561157a57fe5b6000918252602080832090910154600160a060020a031683528201929092526040018120805460ff1916815560018181018390556002820183905560039091019190915501611557565b600160a060020a038b1660009081526004870160205260408120805460ff1916815560018101829055600281018290559061160260038301826124f0565b50506001909301926114a0565b600160a060020a0388166000908152600b60205260408120805460ff1916815560018101829055600281018290559061164b60038301826124f0565b5050600190980197611405565b611664600a60006124f0565b61166c610c82565b6007555050505050505050505050565b60008083151561168f57600091506116ae565b5082820282848281151561169f57fe5b04146116aa57600080fd5b8091505b5092915050565b60008111156111e357600160a060020a038216600090815260096020526040902054151561173657600880546001810182556000919091527ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee301805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0384161790555b600160a060020a03821660009081526009602052604090205461175f908263ffffffff61239316565b600160a060020a0383166000908152600960205260409020555050565b60008080831161178b57600080fd5b828481151561179657fe5b04949350505050565b600060ff8316151561182457600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906113bc565b8260ff16600114156118a957600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906113cb565b8260ff166002141561192e57600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906113da565b8260ff166003141561054757600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906113e9565b600160a060020a038216600090815260056020818152604092839020835160a08101855281548186019081526001830154606080840191909152600284015460808401529082528551908101865260038301548152600483015481850152919093015493810193909352810191909152611a33908263ffffffff6123a516565b600160a060020a03909216600090815260056020818152604092839020855180518255808301516001830155840151600282015594810151805160038701559081015160048601559091015192019190915550565b600080606060008085519350836020026040519080825280601f01601f191660200182016040528015611ac5578160200160208202803883390190505b509250600091505b83821015611b80575060005b6020811015611b75578582815181101515611af057fe5b9060200190602002015181602081101515611b0757fe5b1a7f01000000000000000000000000000000000000000000000000000000000000000283828460200201815181101515611b3d57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600101611ad9565b600190910190611acd565b826040518082805190602001908083835b60208310611bb05780518252601f199092019160209182019101611b91565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091209998505050505050505050565b604080517fd90bd651000000000000000000000000000000000000000000000000000000008152600160a060020a0383811660048301529151849283169163d90bd6519160248083019260209291908290030181600087803b158015611c4b57600080fd5b505af1158015611c5f573d6000803e3d6000fd5b505050506040513d6020811015611c7557600080fd5b50511515611ccd576040805160e560020a62461bcd02815260206004820152601360248201527f556e726567697374657265642064657669636500000000000000000000000000604482015290519081900360640190fd5b505050565b600160a060020a0385166000908152600b60205260408120805490919081908190819060ff161515611d61578454600160ff1990911681178655600a805491820181556000527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a801805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038c161790555b600160a060020a03891660009081526004860160205260409020805490945060ff161515611dd3578354600160ff1990911681178555600386018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038b161790555b600160a060020a03881660009081526004850160205260409020805490935060ff161515611e45578254600160ff1990911681178455600385018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038a161790555b8260020154871115611e97576002830180549088905560018501549088039250611e75908363ffffffff61239316565b600180860191909155850154611e91908363ffffffff61239316565b60018601555b8260030154861115611ee9575060038201805490869055600284015490860390611ec7908263ffffffff61239316565b600280860191909155850154611ee3908263ffffffff61239316565b60028601555b50505050505050505050565b611efd612540565b81611f0b84602001516122ee565b1015611f61576040805160e560020a62461bcd02815260206004820152601660248201527f496e737566666963656e742066726565207374616b6500000000000000000000604482015290519081900360640190fd5b6020830151611f76908363ffffffff6123d016565b60208401525090919050565b600160a060020a0380821660009081526004602052604081205490911681811561203357600154600160a060020a0316331461202e576040805160e560020a62461bcd02815260206004820152602660248201527f4f6e6c79207468652063726f6e206163636f756e74616e742063616e2063616c60448201527f6c20746869730000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b6116ae565b61204584600160a060020a0316612455565b151561209b576040805160e560020a62461bcd02815260206004820152601e60248201527f496e76616c696420666c65657420636f6e747261637420616464726573730000604482015290519081900360640190fd5b83915081600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b1580156120dc57600080fd5b505af11580156120f0573d6000803e3d6000fd5b505050506040513d602081101561210657600080fd5b50519050600160a060020a03811633146116ae576040805160e560020a62461bcd02815260206004820152602560248201527f4f6e6c792074686520666c656574206163636f756e74616e742063616e20646f60448201527f2074686973000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b612198612540565b82516121aa908363ffffffff61245d16565b83525090919050565b6121bb612540565b816121c984600001516122ee565b1015612245576040805160e560020a62461bcd02815260206004820152602160248201527f43616e277420756e7374616b65206d6f7265207468616e206973207374616b6560448201527f6400000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b8251612257908363ffffffff6123d016565b83526020830151611f76908363ffffffff61245d16565b600160a060020a038216600090815260056020818152604092839020835160a08101855281548186019081526001830154606080840191909152600284015460808401529082528551908101865260038301548152600483015481850152919093015493810193909352810191909152611a33908263ffffffff61219016565b60006122fb82600061245d565b6040015192915050565b600061231282600061245d565b5192915050565b600160a060020a0381166000908152600660209081526040808320815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601526005909201549282019290925291810191909152610597906113bc565b6000828201838110156116aa57600080fd5b6123ad612540565b8251604001516123c3908363ffffffff61239316565b8351604001525090919050565b6123d8612566565b6123e383600061245d565b905081816040015110151515612443576040805160e560020a62461bcd02815260206004820152601b60248201527f496e737566666963656e742066756e647320746f206465647563740000000000604482015290519081900360640190fd5b60408101805192909203909152919050565b6000903b1190565b612465612566565b61246e836124e1565b15156124aa576040805160608101825283815243602082015284518583015191928301916124a19163ffffffff61239316565b90529050610597565b6040805160608101909152835181906124c9908563ffffffff61239316565b81524360208201526040858101519101529050610597565b60200151600343919091031090565b508054600082559060005260206000209081019061250e9190612588565b50565b6060604051908101604052806003906020820280388339509192915050565b6040516102ad806125a783390190565b60c060405190810160405280612554612566565b8152602001612561612566565b905290565b6060604051908101604052806000815260200160008152602001600081525090565b610c9891905b808211156125a2576000815560010161258e565b50905600608060405234801561001057600080fd5b506040516060806102ad83398101604090815281516020830151919092015160018054600160a060020a03938416600160a060020a03199182161790915560008054948416948216949094179093556002805492909116919092161790556102308061007d6000396000f3006080604052600436106100775763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633c5f7d46811461007c5780634fb3ccc5146100a4578063570ca735146100d5578063a0619d4a146100ea578063a58bbebd1461011f578063d90bd65114610145575b600080fd5b34801561008857600080fd5b506100a2600160a060020a03600435166024351515610166565b005b3480156100b057600080fd5b506100b9610191565b60408051600160a060020a039092168252519081900360200190f35b3480156100e157600080fd5b506100b96101a0565b3480156100f657600080fd5b5061010b600160a060020a03600435166101af565b604080519115158252519081900360200190f35b34801561012b57600080fd5b506100a2600160a060020a036004351660243515156101c4565b34801561015157600080fd5b5061010b600160a060020a03600435166101ef565b600160a060020a03919091166000908152600660205260409020805460ff1916911515919091179055565b600254600160a060020a031681565b600154600160a060020a031681565b60076020526000908152604090205460ff1681565b600160a060020a03919091166000908152600760205260409020805460ff1916911515919091179055565b60066020526000908152604090205460ff16815600a165627a7a7230582089b9bcc713b4f4f96c8f5c4ee7ee9d9db9dcd4998680fd1044cba3ec2911015e0029a165627a7a7230582096c5050737d732109214b06c488af39b30e90e126af363f9f536f2efa752ff9f0029"
  end

  defp prodRegistryContract() do
    "0x6080604052600436106100e25763ffffffff60e060020a6000350416630a938dff81146100e75780630ac168a1146101205780631b3b98c8146101375780631dd44706146101a15780634fb3ccc5146101b6578063534a2422146101e75780636f9874a4146101fb5780637fca4a29146102105780638d23fc61146102315780638da5cb5b1461025257806399ab110d14610267578063acc77cba14610287578063b0128d921461029b578063be3bb93c146102b3578063c487e3f7146102da578063c4a9e116146102e2578063c76a1173146102f7578063cb106cf81461031b575b600080fd5b3480156100f357600080fd5b5061010e60ff60043516600160a060020a0360243516610330565b60408051918252519081900360200190f35b34801561012c57600080fd5b5061013561059d565b005b34801561014357600080fd5b50604080516060818101909252610135916004803592600160a060020a0360243581169360443590911692606435926084359260a4359236929091610124919060c4906003908390839080828437509396506107ed95505050505050565b3480156101ad57600080fd5b50610135610acb565b3480156101c257600080fd5b506101cb610c7e565b60408051600160a060020a039092168252519081900360200190f35b610135600160a060020a0360043516610c8d565b34801561020757600080fd5b5061010e610d6d565b34801561021c57600080fd5b50610135600160a060020a0360043516610d87565b34801561023d57600080fd5b506101cb600160a060020a0360043516610fcf565b34801561025e57600080fd5b506101cb610fea565b34801561027357600080fd5b506101356004803560248101910135610ff9565b610135600160a060020a0360043516611181565b3480156102a757600080fd5b506101356004356112d3565b3480156102bf57600080fd5b5061010e60ff60043516600160a060020a036024351661139c565b6101356113af565b3480156102ee57600080fd5b5061010e6113bb565b34801561030357600080fd5b50610135600160a060020a03600435166024356113c1565b34801561032757600080fd5b5061010e6114a2565b600060ff831615156103bb57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114a8565b9050610597565b8260ff166001141561043f57600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114b7565b8260ff16600214156104c357600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114c6565b8260ff166003141561054757600160a060020a038216600090815260066020908152604091829020825160a0810184528154818501908152600183015460608084019190915260028401546080840152908252845190810185526003830154815260048301548185015260059092015493820193909352908201526103b4906114d5565b6040805160e560020a62461bcd02815260206004820152601260248201527f556e68616e646c656420617267756d656e740000000000000000000000000000604482015290519081900360640190fd5b92915050565b60008080803341148015906105b157504115155b80156105c85750600154600160a060020a03163314155b15610643576040805160e560020a62461bcd02815260206004820152603060248201527f4f6e6c7920746865206d696e6572206f662074686520626c6f636b2063616e2060448201527f63616c6c2074686973206d6574686f6400000000000000000000000000000000606482015290519081900360840190fd5b3341146106c0576040805160e560020a62461bcd02815260206004820152603060248201527f4f6e6c7920746865206d696e6572206f662074686520626c6f636b2063616e2060448201527f63616c6c2074686973206d6574686f6400000000000000000000000000000000606482015290519081900360840190fd5b6106c8610d6d565b600754146106d8576106d86114e4565b6106fb416106f6670de0b6b3a764000061271063ffffffff61176816565b6117a1565b600093505b6008548410156107db57600880548590811061071857fe5b6000918252602080832090910154600160a060020a031680835260099091526040909120549093506107529061271063ffffffff61186816565b915061075f60008461188b565b90508082111561076d578091505b60008211156107b7576107808383611a9f565b6040518290600160a060020a038516907fc083a1647e3ee591bf42b82564ffb4d16fdbb26068f0080da911c8d8300fd84a90600090a35b600160a060020a038316600090815260096020526040812055600190930192610700565b6107e7600860006125de565b50505050565b6060600088438110610849576040805160e560020a62461bcd02815260206004820152601760248201527f5469636b65742066726f6d20746865206675747572653f000000000000000000604482015290519081900360640190fd5b6007546000190161086282619d8063ffffffff61186816565b146108b7576040805160e560020a62461bcd02815260206004820152600b60248201527f57726f6e672065706f6368000000000000000000000000000000000000000000604482015290519081900360640190fd5b8686171515610910576040805160e560020a62461bcd02815260206004820152601460248201527f496e76616c6964207469636b65742076616c7565000000000000000000000000604482015290519081900360640190fd5b60408051600680825260e08201909252906020820160c080388339019050509250894083600081518110151561094257fe5b602090810290910101528251600160a060020a038a16908490600190811061096657fe5b602090810290910101528251600160a060020a038916908490600290811061098a57fe5b6020908102909101015282518790849060039081106109a557fe5b6020908102909101015282518690849060049081106109c057fe5b6020908102909101015282518590849060059081106109db57fe5b6020908102909101015260016109f084611b74565b60408087015187516020808a0151845160008082528184018088529790975260ff9094168486015260608401929092526080830191909152915160a080830194601f198301938390039091019190865af1158015610a52573d6000803e3d6000fd5b505050602060405103519150610a688983611cd2565b610a758989848a8a611dbe565b81600160a060020a031688600160a060020a03168a600160a060020a03167fc21a4132cfb2e72d1dd6f45bcb2dabb1722a19b036c895975db93175b1c5c06f60405160405180910390a450505050505050505050565b336000818152600560208181526040808420815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601529482015492850192909252918101929092529190610b3c906114d5565b905060008111610b96576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610c02908263ffffffff611fe116565b600160a060020a0384166000818152600560208181526040808420865180518255808401516001830155820151600282015595820151805160038801559182015160048701559081015194909101939093559151909183156108fc02918491818181858888f193505050501580156107e7573d6000803e3d6000fd5b600154600160a060020a031681565b6000610c988261206e565b600160a060020a038116600090815260066020908152604091829020825160a081018452815481850190815260018301546060808401919091526002840154608084015290825284519081018552600383015481526004830154818501526005909201549382019390935290820152909150610d1a903463ffffffff61227c16565b600160a060020a0390911660009081526006602090815260409182902083518051825580830151600183015583015160028201559281015180516003850155908101516004840155015160059091015550565b6000610d8143619d8063ffffffff61186816565b90505b90565b600080600080610d968561206e565b935083600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b158015610dd657600080fd5b505af1158015610dea573d6000803e3d6000fd5b505050506040513d6020811015610e0057600080fd5b5051600160a060020a038516600090815260066020908152604091829020825160a08101845281548185019081526001830154606080840191909152600284015460808401529082528451908101855260038301548152600483015481850152600583015494810194909452918201929092529194509250610e81906114d5565b905060008111610edb576040805160e560020a62461bcd02815260206004820152601060248201527f43616e2774207769746864726177203000000000000000000000000000000000604482015290519081900360640190fd5b6040805160a08101825283548183019081526001850154606080840191909152600286015460808401529082528251908101835260038501548152600485015460208281019190915260058601549382019390935291810191909152610f47908263ffffffff611fe116565b600160a060020a038086166000908152600660209081526040808320855180518255808401516001830155820151600282015594820151805160038701559182015160048601559081015160059094019390935591519085169183156108fc02918491818181858888f19350505050158015610fc7573d6000803e3d6000fd5b505050505050565b600460205260009081526040902054600160a060020a031681565b600054600160a060020a031681565b60006110036125ff565b82158061101257506009830615155b15611067576040805160e560020a62461bcd02815260206004820152601560248201527f496e76616c6964207469636b6574206c656e6774680000000000000000000000604482015290519081900360640190fd5b600091505b828210156107e75760408051606081019091528085856006860181811061108f57fe5b60209081029290920135835250018585600786018181106110ac57fe5b60209081029290920135835250018585600886018181106110c957fe5b60200291909101359091525090506111768484848181106110e657fe5b6020029190910135905061111286866001870181811061110257fe5b9050602002013560001916610d84565b61112487876002880181811061110257fe5b87876003880181811061113357fe5b6020029190910135905088886004890181811061114c57fe5b60200291909101359050898960058a0181811061116557fe5b9050602002013560001916876107ed565b60098201915061106c565b600154600090600160a060020a0316331461119b57600080fd5b600160a060020a038281166000908152600460205260409020541615611231576040805160e560020a62461bcd02815260206004820152602560248201527f44656c656761746520616c726561647920686173206120666c65657420636f6e60448201527f7472616374000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60015430908390600160a060020a031661124961261e565b600160a060020a03938416815291831660208301529091166040808301919091525190819003606001906000f080158015611288573d6000803e3d6000fd5b50600160a060020a038381166000908152600460205260409020805473ffffffffffffffffffffffffffffffffffffffff191691831691909117905590506112cf81610c8d565b5050565b33600081815260056020818152604092839020835160a0810185528154818601908152600183015460608084019190915260028401546080840152908252855190810186526003830154815260048301548185015291909301549381019390935281019190915261134a908363ffffffff61229f16565b600160a060020a03909116600090815260056020818152604092839020845180518255808301516001830155840151600282015593810151805160038601559081015160048501559091015191015550565b60006113a8838361188b565b9392505050565b6113b9333461235a565b565b60025481565b60006113cc8361206e565b600160a060020a038116600090815260066020908152604091829020825160a08101845281548185019081526001830154606080840191909152600284015460808401529082528451908101855260038301548152600483015481850152600590920154938201939093529082015290915061144e908363ffffffff61229f16565b600160a060020a039091166000908152600660209081526040918290208351805182558083015160018301558301516002820155928101518051600385015590810151600484015501516005909101555050565b60035481565b600061059782600001516123da565b600061059782600001516123f1565b600061059782602001516123f1565b600061059782602001516123da565b6000808080808080808080805b600a5489101561174457600a80548a90811061150957fe5b600091825260209091200154600160a060020a0316975061152988612405565b965061153c87606463ffffffff61186816565b600160a060020a0389166000908152600b602052604090206001810154919b509650611585906115749061040063ffffffff61176816565b60028801549063ffffffff61247f16565b9450600093505b60038601548410156116fb57600386018054859081106115a857fe5b6000918252602080832090910154600160a060020a03168083526004890190915260409091206001810154919c5093506115ff906115ee9061040063ffffffff61176816565b60028501549063ffffffff61247f16565b9150611633856116278c61161b8661271063ffffffff61176816565b9063ffffffff61176816565b9063ffffffff61186816565b915061163f8b836117a1565b5060005b60038301548110156116b057826004016000846003018381548110151561166657fe5b6000918252602080832090910154600160a060020a031683528201929092526040018120805460ff1916815560018181018390556002820183905560039091019190915501611643565b600160a060020a038b1660009081526004870160205260408120805460ff191681556001810182905560028101829055906116ee60038301826125de565b505060019093019261158c565b600160a060020a0388166000908152600b60205260408120805460ff1916815560018101829055600281018290559061173760038301826125de565b50506001909801976114f1565b611750600a60006125de565b611758610d6d565b6007555050505050505050505050565b60008083151561177b576000915061179a565b5082820282848281151561178b57fe5b041461179657600080fd5b8091505b5092915050565b60008111156112cf57600160a060020a038216600090815260096020526040902054151561182257600880546001810182556000919091527ff3f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee301805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0384161790555b600160a060020a03821660009081526009602052604090205461184b908263ffffffff61247f16565b600160a060020a0383166000908152600960205260409020555050565b60008080831161187757600080fd5b828481151561188257fe5b04949350505050565b600060ff8316151561191057600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114a8565b8260ff166001141561199557600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114b7565b8260ff1660021415611a1a57600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114c6565b8260ff166003141561054757600160a060020a038216600090815260056020818152604092839020835160a081018552815481860190815260018301546060808401919091526002840154608084015290825285519081018652600383015481526004830154818501529190930154938101939093528101919091526103b4906114d5565b600160a060020a038216600090815260056020818152604092839020835160a08101855281548186019081526001830154606080840191909152600284015460808401529082528551908101865260038301548152600483015481850152919093015493810193909352810191909152611b1f908263ffffffff61249116565b600160a060020a03909216600090815260056020818152604092839020855180518255808301516001830155840151600282015594810151805160038701559081015160048601559091015192019190915550565b600080606060008085519350836020026040519080825280601f01601f191660200182016040528015611bb1578160200160208202803883390190505b509250600091505b83821015611c6c575060005b6020811015611c61578582815181101515611bdc57fe5b9060200190602002015181602081101515611bf357fe5b1a7f01000000000000000000000000000000000000000000000000000000000000000283828460200201815181101515611c2957fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600101611bc5565b600190910190611bb9565b826040518082805190602001908083835b60208310611c9c5780518252601f199092019160209182019101611c7d565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091209998505050505050505050565b604080517fd90bd651000000000000000000000000000000000000000000000000000000008152600160a060020a0383811660048301529151849283169163d90bd6519160248083019260209291908290030181600087803b158015611d3757600080fd5b505af1158015611d4b573d6000803e3d6000fd5b505050506040513d6020811015611d6157600080fd5b50511515611db9576040805160e560020a62461bcd02815260206004820152601360248201527f556e726567697374657265642064657669636500000000000000000000000000604482015290519081900360640190fd5b505050565b600160a060020a0385166000908152600b60205260408120805490919081908190819060ff161515611e4d578454600160ff1990911681178655600a805491820181556000527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a801805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038c161790555b600160a060020a03891660009081526004860160205260409020805490945060ff161515611ebf578354600160ff1990911681178555600386018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038b161790555b600160a060020a03881660009081526004850160205260409020805490935060ff161515611f31578254600160ff1990911681178455600385018054918201815560009081526020902001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038a161790555b8260020154871115611f83576002830180549088905560018501549088039250611f61908363ffffffff61247f16565b600180860191909155850154611f7d908363ffffffff61247f16565b60018601555b8260030154861115611fd5575060038201805490869055600284015490860390611fb3908263ffffffff61247f16565b600280860191909155850154611fcf908263ffffffff61247f16565b60028601555b50505050505050505050565b611fe961262e565b81611ff784602001516123da565b101561204d576040805160e560020a62461bcd02815260206004820152601660248201527f496e737566666963656e742066726565207374616b6500000000000000000000604482015290519081900360640190fd5b6020830151612062908363ffffffff6124bc16565b60208401525090919050565b600160a060020a0380821660009081526004602052604081205490911681811561211f57600154600160a060020a0316331461211a576040805160e560020a62461bcd02815260206004820152602660248201527f4f6e6c79207468652063726f6e206163636f756e74616e742063616e2063616c60448201527f6c20746869730000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b61179a565b61213184600160a060020a0316612541565b1515612187576040805160e560020a62461bcd02815260206004820152601e60248201527f496e76616c696420666c65657420636f6e747261637420616464726573730000604482015290519081900360640190fd5b83915081600160a060020a0316634fb3ccc56040518163ffffffff1660e060020a028152600401602060405180830381600087803b1580156121c857600080fd5b505af11580156121dc573d6000803e3d6000fd5b505050506040513d60208110156121f257600080fd5b50519050600160a060020a038116331461179a576040805160e560020a62461bcd02815260206004820152602560248201527f4f6e6c792074686520666c656574206163636f756e74616e742063616e20646f60448201527f2074686973000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b61228461262e565b8251612296908363ffffffff61254916565b83525090919050565b6122a761262e565b816122b584600001516123da565b1015612331576040805160e560020a62461bcd02815260206004820152602160248201527f43616e277420756e7374616b65206d6f7265207468616e206973207374616b6560448201527f6400000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b8251612343908363ffffffff6124bc16565b83526020830151612062908363ffffffff61254916565b600160a060020a038216600090815260056020818152604092839020835160a08101855281548186019081526001830154606080840191909152600284015460808401529082528551908101865260038301548152600483015481850152919093015493810193909352810191909152611b1f908263ffffffff61227c16565b60006123e7826000612549565b6040015192915050565b60006123fe826000612549565b5192915050565b600160a060020a0381166000908152600660209081526040808320815160a081018352815481840190815260018301546060808401919091526002840154608084015290825283519081018452600383015481526004830154818601526005909201549282019290925291810191909152610597906114a8565b60008282018381101561179657600080fd5b61249961262e565b8251604001516124af908363ffffffff61247f16565b8351604001525090919050565b6124c4612654565b6124cf836000612549565b90508181604001511015151561252f576040805160e560020a62461bcd02815260206004820152601b60248201527f496e737566666963656e742066756e647320746f206465647563740000000000604482015290519081900360640190fd5b60408101805192909203909152919050565b6000903b1190565b612551612654565b61255a836125cd565b15156125965760408051606081018252838152436020820152845185830151919283019161258d9163ffffffff61247f16565b90529050610597565b6040805160608101909152835181906125b5908563ffffffff61247f16565b81524360208201526040858101519101529050610597565b602001516202ac6043919091031090565b50805460008255906000526020600020908101906125fc9190612676565b50565b6060604051908101604052806003906020820280388339509192915050565b6040516102db8061269583390190565b60c060405190810160405280612642612654565b815260200161264f612654565b905290565b6060604051908101604052806000815260200160008152602001600081525090565b610d8491905b80821115612690576000815560010161267c565b50905600608060405234801561001057600080fd5b506040516060806102db83398101604090815281516020830151919092015160018054600160a060020a03938416600160a060020a031991821617909155600080549484169482169490941790935560028054929091169190921617905561025e8061007d6000396000f3006080604052600436106100775763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633c5f7d46811461007c5780634fb3ccc5146100a4578063570ca735146100d5578063a0619d4a146100ea578063a58bbebd1461011f578063d90bd65114610145575b600080fd5b34801561008857600080fd5b506100a2600160a060020a03600435166024351515610166565b005b3480156100b057600080fd5b506100b96101a8565b60408051600160a060020a039092168252519081900360200190f35b3480156100e157600080fd5b506100b96101b7565b3480156100f657600080fd5b5061010b600160a060020a03600435166101c6565b604080519115158252519081900360200190f35b34801561012b57600080fd5b506100a2600160a060020a036004351660243515156101db565b34801561015157600080fd5b5061010b600160a060020a036004351661021d565b600154600160a060020a0316331461017d57600080fd5b600160a060020a03919091166000908152600660205260409020805460ff1916911515919091179055565b600254600160a060020a031681565b600154600160a060020a031681565b60076020526000908152604090205460ff1681565b600154600160a060020a031633146101f257600080fd5b600160a060020a03919091166000908152600760205260409020805460ff1916911515919091179055565b60066020526000908152604090205460ff16815600a165627a7a72305820d8e16601d99b1e7e6712a6b82a0b41ca239b8bd766bb3da4e22fbb9d01c67acd0029a165627a7a72305820975eb2e6358a47c7f368c6b8cb129a25499d2fe13d9bff83d4777d7a5c2461f50029"
  end

  defp fleet_contract() do
    "0x6080604052600436106100775763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416633c5f7d46811461007c5780634ef1aee4146100a45780634fb3ccc5146100df578063504f04b714610110578063570ca7351461013c578063d90bd65114610151575b600080fd5b34801561008857600080fd5b506100a2600160a060020a03600435166024351515610172565b005b3480156100b057600080fd5b506100cb600160a060020a036004358116906024351661019d565b604080519115158252519081900360200190f35b3480156100eb57600080fd5b506100f46101bd565b60408051600160a060020a039092168252519081900360200190f35b34801561011c57600080fd5b506100a2600160a060020a036004358116906024351660443515156101cc565b34801561014857600080fd5b506100f4610206565b34801561015d57600080fd5b506100cb600160a060020a0360043516610215565b600160a060020a03919091166000908152600660205260409020805460ff1916911515919091179055565b600760209081526000928352604080842090915290825290205460ff1681565b600254600160a060020a031681565b600160a060020a03928316600090815260076020908152604080832094909516825292909252919020805460ff1916911515919091179055565b600154600160a060020a031681565b60066020526000908152604090205460ff16815600a165627a7a723058203f95e73b5ed23de51b088174d875d425749fcd0c4bdc6ed4d497d05aa560bc8e0029"
  end
end
